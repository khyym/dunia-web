<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dunia</title>
    <meta name="robots" content="noindex">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: #000407;
            color: #fff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        .card {
            background: linear-gradient(180deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0.02) 100%);
            border-radius: 28px;
            padding: 48px 36px;
            max-width: 380px;
            width: 100%;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .logo {
            width: 100px;
            height: 100px;
            margin: 0 auto 28px;
        }
        .logo img {
            width: 100%;
            height: 100%;
        }
        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 24px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 12px;
        }
        .message {
            font-size: 15px;
            color: rgba(255,255,255,0.6);
            line-height: 1.5;
            margin-bottom: 28px;
        }
        .btn {
            display: inline-block;
            width: 100%;
            padding: 16px 32px;
            background: #fff;
            color: #000;
            font-size: 16px;
            font-weight: 600;
            text-decoration: none;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
        }
        .btn:hover { transform: scale(1.02); }
        .btn:active { transform: scale(0.98); }
        .btn.hidden { display: none; }
        .btn.secondary {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            margin-top: 12px;
        }
        .status {
            font-size: 13px;
            color: rgba(255,255,255,0.4);
            margin-top: 16px;
        }
        .status.hidden { display: none; }
        .error { color: #ef4444; }
        .success { color: #22c55e; }
        .confetti {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 100;
        }
        .confetti-piece {
            position: absolute;
            width: 8px; height: 8px;
            animation: confettiFall 3s ease-out forwards;
        }
        @keyframes confettiFall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="card">
        <div class="logo">
            <img src="https://dunia.one/images/logo.png" alt="dunia">
        </div>
        <div class="spinner" id="spinner"></div>
        <h1 class="title" id="title">doğrulanıyor...</h1>
        <p class="message" id="message">email adresin doğrulanıyor, lütfen bekle.</p>
        <button class="btn hidden" id="btn">devam et</button>
        <button class="btn secondary hidden" id="btn-appstore">app store'dan indir</button>
        <p class="status" id="status"></p>
    </div>
    
    <div class="confetti" id="confetti"></div>

    <script>
        (function() {
            const SUPABASE_URL = 'https://mjxqfmlsjokcuwugytve.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1qeHFmbWxzam9rY3V3dWd5dHZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjQ5NTk5MDAsImV4cCI6MjA0MDUzNTkwMH0.tBeYr2BaPMgGJBJ0rxJMBQaprXNRfyX9dEJNOqmFfHU';
            const APP_STORE_URL = 'https://apps.apple.com/app/dunia/id6450894038';
            
            // Parse URL params
            const params = new URLSearchParams(window.location.search);
            const hash = window.location.hash;
            const hashParams = new URLSearchParams(hash.replace('#', ''));
            
            const token = params.get('token') || hashParams.get('token');
            const userId = params.get('user_id') || hashParams.get('user_id');
            const type = params.get('type') || hashParams.get('type') || 'verify';
            
            // DOM elements
            const spinner = document.getElementById('spinner');
            const title = document.getElementById('title');
            const message = document.getElementById('message');
            const btn = document.getElementById('btn');
            const btnAppstore = document.getElementById('btn-appstore');
            const status = document.getElementById('status');
            const confettiContainer = document.getElementById('confetti');
            
            // Build deep link
            function buildDeepLink() {
                const dlParams = new URLSearchParams();
                dlParams.set('type', 'verified');
                if (userId) dlParams.set('user_id', userId);
                return 'dunia://auth/callback?' + dlParams.toString();
            }
            
            const deepLink = buildDeepLink();
            
            // Confetti effect
            function showConfetti() {
                const colors = ['#22c55e', '#3b82f6', '#8b5cf6', '#ec4899', '#ffffff'];
                for (let i = 0; i < 50; i++) {
                    const piece = document.createElement('div');
                    piece.className = 'confetti-piece';
                    piece.style.left = Math.random() * 100 + '%';
                    piece.style.background = colors[Math.floor(Math.random() * colors.length)];
                    piece.style.animationDelay = Math.random() * 0.5 + 's';
                    piece.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                    confettiContainer.appendChild(piece);
                }
                setTimeout(() => { confettiContainer.innerHTML = ''; }, 4000);
            }
            
            // Show success
            function showSuccess(alreadyVerified) {
                spinner.style.display = 'none';
                if (alreadyVerified) {
                    title.textContent = 'zaten doğrulanmış';
                    message.textContent = 'email adresin daha önce doğrulanmış.';
                } else {
                    title.textContent = 'email doğrulandı!';
                    message.textContent = 'hesabın onaylandı. artık onaylı rozetine sahipsin!';
                    showConfetti();
                }
                showButtons();
            }
            
            // Show error
            function showError(msg) {
                spinner.style.display = 'none';
                title.textContent = 'bir sorun oluştu';
                title.classList.add('error');
                message.textContent = msg || 'doğrulama linki geçersiz veya süresi dolmuş olabilir.';
                showButtons();
            }
            
            // Show buttons
            function showButtons() {
                btn.classList.remove('hidden');
                btnAppstore.classList.remove('hidden');
                status.textContent = '';
                
                btn.addEventListener('click', function() {
                    window.location.href = deepLink;
                    setTimeout(function() {
                        if (!document.hidden) {
                            // App didn't open, stay on page
                            status.textContent = 'uygulama açılamadı. app store\'dan indirebilirsin.';
                        }
                    }, 1500);
                });
                
                btnAppstore.addEventListener('click', function() {
                    window.location.href = APP_STORE_URL;
                });
            }
            
            // Verify email via Supabase RPC
            async function verifyEmail() {
                if (!token || !userId) {
                    showError('doğrulama bilgileri eksik.');
                    return;
                }
                
                try {
                    const response = await fetch(SUPABASE_URL + '/rest/v1/rpc/rpc_verify_email_with_token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': 'Bearer ' + SUPABASE_ANON_KEY
                        },
                        body: JSON.stringify({
                            p_token: token,
                            p_user_id: userId
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result && result.success) {
                        showSuccess(result.already_verified);
                    } else {
                        showError(result.error || 'doğrulama başarısız oldu.');
                    }
                } catch (error) {
                    console.error('Verification error:', error);
                    showError('bir hata oluştu. lütfen tekrar dene.');
                }
            }
            
            // Start verification
            verifyEmail();
            
        })();
    </script>
</body>
</html>
