<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dunia</title>
    <meta name="robots" content="noindex">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: #000407;
            color: #fff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        .card {
            background: linear-gradient(180deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0.02) 100%);
            border-radius: 28px;
            padding: 48px 36px;
            max-width: 380px;
            width: 100%;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .logo { width: 100px; height: 100px; margin: 0 auto 28px; }
        .logo img { width: 100%; height: 100%; }
        .spinner {
            width: 32px; height: 32px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 24px;
        }
        .spinner.hidden { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .title { font-size: 22px; font-weight: 700; margin-bottom: 12px; }
        .message { font-size: 15px; color: rgba(255,255,255,0.6); line-height: 1.5; margin-bottom: 28px; }
        .btn {
            display: block; width: 100%; padding: 16px 32px;
            background: #fff; color: #000;
            font-size: 16px; font-weight: 600;
            text-decoration: none; border-radius: 50px;
            border: none; cursor: pointer;
        }
        .btn.hidden { display: none; }
        .btn.secondary { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: #fff; margin-top: 12px; }
        .confetti { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        .confetti-piece { position: absolute; width: 8px; height: 8px; animation: confettiFall 3s ease-out forwards; }
        @keyframes confettiFall { 0% { transform: translateY(-100vh) rotate(0); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
    </style>
</head>
<body>
    <div class="card">
        <div class="logo"><img src="https://dunia.one/images/logo.png" alt="dunia"></div>
        <div class="spinner" id="spinner"></div>
        <h1 class="title" id="title">doğrulanıyor...</h1>
        <p class="message" id="message">email adresin doğrulanıyor.</p>
        <button class="btn hidden" id="btn">devam et</button>
        <button class="btn secondary hidden" id="btn-appstore">app store'dan indir</button>
    </div>
    <div class="confetti" id="confetti"></div>

    <script>
        // No exposed credentials - all API calls go through secure proxy
        const API_BASE = 'https://dunia.one/api';
        const APP_STORE_URL = 'https://apps.apple.com/app/dunia/id6450894038';
        
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token');
        const userId = params.get('user_id');
        
        const $ = id => document.getElementById(id);
        
        function showConfetti() {
            const colors = ['#22c55e', '#3b82f6', '#8b5cf6', '#ec4899', '#fff'];
            for (let i = 0; i < 50; i++) {
                const p = document.createElement('div');
                p.className = 'confetti-piece';
                p.style.left = Math.random() * 100 + '%';
                p.style.background = colors[Math.floor(Math.random() * colors.length)];
                p.style.animationDelay = Math.random() * 0.5 + 's';
                p.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                $('confetti').appendChild(p);
            }
            setTimeout(() => $('confetti').innerHTML = '', 4000);
        }
        
        function show(titleText, messageText, confetti) {
            $('spinner').classList.add('hidden');
            $('title').textContent = titleText;
            $('message').textContent = messageText;
            $('btn').classList.remove('hidden');
            $('btn-appstore').classList.remove('hidden');
            if (confetti) showConfetti();
            
            const deepLink = 'dunia://auth/callback?type=verified&user_id=' + (userId || '');
            $('btn').onclick = () => { window.location.href = deepLink; };
            $('btn-appstore').onclick = () => { window.location.href = APP_STORE_URL; };
        }
        
        async function verify() {
            if (!token || !userId) {
                show('geçersiz link', 'doğrulama bilgileri eksik.', false);
                return;
            }
            
            try {
                // Use secure API proxy instead of direct Supabase call
                const res = await fetch(API_BASE + '/verify-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: token, user_id: userId })
                });
                
                const data = await res.json();
                
                if (data.success === true) {
                    if (data.already_verified === true) {
                        show('zaten doğrulanmış', 'email adresin daha önce doğrulanmış.', false);
                    } else {
                        show('email doğrulandı!', 'hesabın onaylandı. artık onaylı rozetine sahipsin!', true);
                    }
                } else {
                    show('doğrulama başarısız', data.error || 'link geçersiz veya süresi dolmuş.', false);
                }
                
            } catch (err) {
                show('bağlantı hatası', 'sunucuya ulaşılamadı.', false);
            }
        }
        
        verify();
    </script>
</body>
</html>
